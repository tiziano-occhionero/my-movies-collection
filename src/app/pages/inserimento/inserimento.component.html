<div class="container mt-3">
  <div class="d-flex flex-column">
    <h2>Inserimento Film</h2>

    <!-- Alert modalità offline -->
    <div *ngIf="!isOnline" class="alert alert-warning mt-2">
      Modalità offline: inserimento, rimozione e modifiche non sono disponibili.
    </div>

    <div *ngIf="messaggio" class="alert alert-success mt-2">
      {{ messaggio }}
    </div>

    <!-- Stato ricerca -->
    <div class="mt-2 small text-muted">
      Risultati: {{ film.length }}
    </div>

    <!-- Nessun risultato -->
    <div *ngIf="film.length === 0 && ricercaEffettuata" class="alert alert-warning mt-3">
      Nessun film trovato.
    </div>

    <!-- Risultati -->
    <div *ngIf="film.length > 0" class="row mt-3" id="accordion-container">
      <div *ngFor="let f of film; let i = index" class="col-6 col-md-4 col-lg-3 d-flex mb-3">
        <div class="card h-100 shadow-sm">
          <img *ngIf="f.poster_path" [src]="'https://image.tmdb.org/t/p/w500' + f.poster_path" class="card-img-top"
            [alt]="f.title || 'Poster'" />

          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-2">{{ f.title }}</h5>

            <!-- TUTTO questo blocco resta in fondo alla card -->
            <div class="mt-auto">
              <p class="card-text mb-2">
                <strong>Anno:</strong> {{ f.release_date | date:'yyyy' }}
              </p>

              <!-- Dettagli (overlay, non espande la card) -->
              <div class="accordion position-relative mb-2">
                <div class="accordion-item border-0">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                      [attr.data-bs-target]="'#overlay-' + f.id" aria-expanded="false"
                      [attr.aria-controls]="'overlay-' + f.id" (click)="caricaDettagliFilm(f)">
                      Dettagli
                    </button>
                  </h2>

                  <!-- Overlay assoluto -->
                  <div [id]="'overlay-' + f.id"
                    class="accordion-collapse collapse position-absolute start-0 top-100 mt-1 w-100"
                    data-bs-parent="#accordion-container" style="z-index:1050;">
                    <div class="accordion-body bg-white border rounded shadow p-3">
                      <p class="mb-1"><strong>Genere:</strong> {{ f.genre_names?.join(', ') || 'N/A' }}</p>
                      <p class="mb-1"><strong>Regista:</strong> {{ f.regista || 'N/A' }}</p>
                      <p class="mb-0"><strong>Attori principali:</strong> {{ f.attori?.join(', ') || 'N/A' }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <button class="btn btn-success w-100" (click)="apriModale(f)">
                Aggiungi alla collezione
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modale: conferma aggiunta -->
    <div class="modal fade" id="confermaAggiuntaModal" tabindex="-1" aria-labelledby="confermaAggiuntaModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">

          <div class="modal-body">
            <div class="mb-3">
              <label for="formato" class="form-label">Formato</label>
              <select id="formato" class="form-select" [(ngModel)]="formatoSelezionato">
                <option value="" disabled selected>Seleziona formato</option>
                <option value="uhdbd">UltraHd Blu-ray</option>
                <option value="bd">Blu-ray</option>
                <option value="dvd">DVD</option>
                <option value="vhs">VHS</option>
                <option value="altro">Altro</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="custodia" class="form-label">Tipo di custodia</label>
              <select id="custodia" class="form-select" [(ngModel)]="custodiaSelezionata">
                <option value="" disabled selected>Seleziona custodia</option>
                <option value="standard">Standard</option>
                <option value="steelbook">Steelbook</option>
                <option value="slipcase">Slipcase</option>
                <option value="sJewelBox">Super Jewel Box</option>
                <option value="cofanetto">Cofanetto</option>
                <option value="snapper">Snapper</option>
                <option value="altro">Altro</option>
              </select>
            </div>

            <div *ngIf="confermaSuccesso" class="alert alert-success mt-3">
              Film aggiunto con successo!
            </div>

            <div *ngIf="filmGiaPresente" class="alert alert-warning mt-3">
              Il film è già presente nella collezione o nella wishlist.
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-primary" [disabled]="!formatoSelezionato || !custodiaSelezionata || confermaSuccesso"
              (click)="confermaAggiunta()">
              Conferma
            </button>
            <button class="btn btn-outline-secondary flex-fill"
              [disabled]="!formatoSelezionato || !custodiaSelezionata || confermaSuccesso"
              (click)="aggiungiAllaListaDesideri()">
              Aggiungi alla lista desideri
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- Modale: ACCESSO RICHIESTO (unico, niente duplicati) -->
    <div class="modal fade" id="loginRequiredModal" tabindex="-1" aria-labelledby="loginRequiredLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="loginRequiredLabel" class="modal-title">Accesso richiesto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
          </div>
          <div class="modal-body">
            Per aggiungere film alla tua collezione devi effettuare l’accesso.
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annulla</button>
            <button class="btn btn-primary" (click)="procediAlLogin()">Accedi</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Login Modal -->
    <app-login-modal #loginRef (loggedIn)="onLoggedIn($event)"></app-login-modal>
    <app-logout-modal #logoutRef [modalId]="'logoutModalInserimento'"
      (confermato)="confermaLogout()"></app-logout-modal>

  </div>